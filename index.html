<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skore Point | School Report Card Generator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase functions
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword, 
      signOut,
      onAuthStateChanged,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      getDocs, 
      query, 
      where, 
      doc, 
      setDoc,
      getDoc,
      updateDoc,
      deleteDoc,
      arrayUnion
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { 
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyASIdYdW94ZJQXsc6BN9Bc28eou0yjPE1U",
      authDomain: "upgrade-16092.firebaseapp.com",
      projectId: "upgrade-16092",
      storageBucket: "upgrade-16092.firebasestorage.app",
      messagingSenderId: "466381827996",
      appId: "1:466381827996:web:6f030e68c526e734a26259",
      measurementId: "G-RGCH68RJ8H"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Make Firebase available globally
    window.firebase = { 
      app,
      auth, 
      db, 
      storage,
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword, 
      signOut, 
      onAuthStateChanged, 
      updateProfile,
      collection, 
      addDoc, 
      getDocs, 
      query, 
      where, 
      doc, 
      setDoc, 
      getDoc, 
      updateDoc,
      deleteDoc,
      arrayUnion,
      ref,
      uploadBytes,
      getDownloadURL
    };
  </script>

  <style>
    /* All existing CSS styles remain the same */
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --primary-light: #4895ef;
      --secondary: #4cc9f0;
      --accent: #7209b7;
      --dark: #121212;
      --darker: #0a0a0a;
      --light: #f8f9fa;
      --gray: #2d3748;
      --gray-light: #4a5568;
      --error: #e53e3e;
      --success: #38a169;
      --warning: #dd6b20;
      --shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      --transition: all 0.3s ease;
      --gradient: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      --card-gradient: linear-gradient(135deg, rgba(67, 97, 238, 0.1) 0%, rgba(114, 9, 183, 0.1) 100%);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: var(--dark);
      color: var(--light);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--gradient);
      opacity: 0.05;
      z-index: -1;
    }

    /* All other CSS styles remain exactly the same */
    /* ... (all the existing CSS code) ... */
  </style>
</head>
<body>
  <!-- LAUNCH SCREEN -->
  <div class="launch-screen" id="launchScreen">
    <!-- Floating particles -->
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>

    <!-- Orbit circles -->
    <div class="orbit">
      <div class="orbit-circle"></div>
      <div class="orbit-circle"></div>
      <div class="orbit-circle"></div>
    </div>

    <!-- Main content -->
    <div class="launch-container">
      <div class="logo-wrapper">
        <div class="logo">
          <span>S</span><span>k</span><span>o</span><span>r</span><span>e</span><span> </span><span>P</span><span>o</span><span>i</span><span>n</span><span>t</span>
        </div>
      </div>
      <div class="tagline">Empowering teachers to save time with Report Card Generator</div>
      <div class="loader">
        <div class="loader-bar"></div>
      </div>
      <div class="loading-text">Loading your experience...</div>
    </div>
  </div>

  <!-- LOGIN SECTION -->
  <div class="container" id="loginSection" style="display:none;">
    <div class="header">
      <h1>Skore Point</h1>
      <p>Teacher & Admin Login</p>
    </div>

    <div id="loginError" class="alert error" style="display:none;">
      <i class="fas fa-exclamation-circle"></i>
      <span></span>
    </div>

    <form id="loginForm">
      <div class="form-group">
        <label><i class="fas fa-envelope"></i> Email</label>
        <input type="email" id="loginEmail" placeholder="Enter your email" required>
      </div>

      <div class="form-group">
        <label><i class="fas fa-lock"></i> Password</label>
        <input type="password" id="loginPassword" placeholder="Enter your password" required>
        <button type="button" class="password-toggle" id="loginToggle"><i class="fas fa-eye"></i></button>
      </div>

      <button class="btn btn-primary" type="submit"><i class="fas fa-sign-in-alt"></i> Sign In</button>

      <div class="loading" id="loginLoading">
        <div class="spinner"></div>
        <p>Checking credentials...</p>
      </div>
    </form>

    <div class="footer">
      Don't have an account? <button id="goRegister">Create One</button>
    </div>
  </div>

  <!-- REGISTER SECTION -->
  <div class="container" id="registerSection" style="display:none;">
    <div class="header">
      <h1>Skore Point</h1>
      <p>Create Admin Account</p>
    </div>

    <div id="registerError" class="alert error" style="display:none;">
      <i class="fas fa-exclamation-circle"></i>
      <span></span>
    </div>
    <div id="registerSuccess" class="alert success" style="display:none;">
      <i class="fas fa-check-circle"></i>
      <span>Account created successfully! Redirecting...</span>
    </div>

    <div class="profile-upload">
      <img id="profilePreview" class="profile-picture" src="https://via.placeholder.com/100" alt="Profile Preview">
      <button type="button" class="btn btn-secondary" id="uploadProfileBtn"><i class="fas fa-camera"></i> Upload Profile Picture</button>
      <input type="hidden" id="profilePictureUrl">
    </div>

    <form id="registerForm">
      <div class="form-group">
        <label><i class="fas fa-user"></i> Full Name</label>
        <input type="text" id="regName" placeholder="Enter your full name" required>
      </div>
      <div class="form-group">
        <label><i class="fas fa-envelope"></i> Email</label>
        <input type="email" id="regEmail" placeholder="Enter email address" required>
      </div>
      <div class="form-group">
        <label><i class="fas fa-book"></i> Subject</label>
        <input type="text" id="regSubject" placeholder="Enter your subject" required>
      </div>
      <div class="form-group">
        <label><i class="fas fa-lock"></i> Password</label>
        <input type="password" id="regPassword" placeholder="Create password (min 6 characters)" required minlength="6">
        <button type="button" class="password-toggle" id="registerToggle"><i class="fas fa-eye"></i></button>
      </div>
      <div class="form-group">
        <label><i class="fas fa-lock"></i> Confirm Password</label>
        <input type="password" id="confirmPassword" placeholder="Confirm password" required>
        <button type="button" class="password-toggle" id="confirmToggle"><i class="fas fa-eye"></i></button>
      </div>
      <button class="btn btn-primary" type="submit"><i class="fas fa-user-plus"></i> Create Account</button>
      <div class="loading" id="registerLoading">
        <div class="spinner"></div>
        <p>Creating account...</p>
      </div>
    </form>

    <div class="footer">
      Already registered? <button id="goLogin">Sign In</button>
    </div>
  </div>

  <!-- DASHBOARD SECTION -->
  <div class="dashboard" id="dashboardSection" style="display:none;">
    <div class="dashboard-top-section">
      <h1>Home</h1>
      <div class="logo">SKORE POINT</div>
    </div>

    <div class="dashboard-cards">
      <div class="card" id="manageSchoolCard" style="display:none;">
        <i class="fas fa-cogs"></i>
        <h3>SCHOOL PORTAL ACCOUNT</h3>
        <p>Manage classes, students, and marks</p>
        <div id="schoolCardInfo" style="margin-top: 15px; text-align: center;">
          <img id="schoolCardLogo" class="school-logo-round" src="" alt="School Logo" style="display:none;">
          <h4 id="schoolCardName"></h4>
          <p>Code: <span id="schoolCardCode"></span></p>
        </div>
        <button class="btn btn-primary" id="openPortalBtn" style="margin-top: 15px;"><i class="fas fa-door-open"></i> OPEN PORTAL</button>
      </div>
      <div class="card" id="joinSchoolCard">
        <i class="fas fa-school"></i>
        <h3>Join a School</h3>
        <p>Join an existing school using its unique code</p>
      </div>
      <div class="card" id="registerSchoolCard">
        <i class="fas fa-plus-circle"></i>
        <h3>Register a School</h3>
        <p>Create a new school and get a unique code</p>
      </div>
    </div>

    <div id="schoolInfo" style="display:none;">
      <h2>Your School: <span id="currentSchoolName"></span></h2>
      <p>School Code: <span id="currentSchoolCode"></span></p>
    </div>
  </div>

  <!-- SCHOOL SETUP SECTION -->
  <div class="school-setup" id="schoolSetupSection" style="display:none;">
    <div class="setup-header">
      <h1>School Setup</h1>
      <p>Choose how you want to proceed with Skore Point</p>
    </div>

    <div class="setup-options">
      <div class="setup-option" id="joinSchoolOption">
        <i class="fas fa-user-plus"></i>
        <h3>Join a School</h3>
        <p>Join an existing school using its unique code</p>
      </div>
      <div class="setup-option" id="registerSchoolOption">
        <i class="fas fa-school"></i>
        <h3>Register a School</h3>
        <p>Create a new school and get a unique code</p>
      </div>
    </div>
  </div>

  <!-- Join School Full Screen Form -->
  <div class="full-screen-form" id="joinSchoolForm" style="display:none;">
    <button class="close-form" id="closeJoinForm"><i class="fas fa-times"></i></button>
    <div class="container">
      <div class="header">
        <h2>Join a School</h2>
        <p>Enter the school details to join</p>
      </div>

      <div id="joinSchoolError" class="alert error" style="display:none;">
        <i class="fas fa-exclamation-circle"></i>
        <span></span>
      </div>

      <form id="joinSchoolFormFields">
        <div class="form-group">
          <label><i class="fas fa-school"></i> School Name</label>
          <input type="text" id="joinSchoolName" placeholder="Enter school name" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-key"></i> School Code</label>
          <input type="text" id="joinSchoolCode" placeholder="Enter school code" required>
        </div>
        <button class="btn btn-primary" type="submit"><i class="fas fa-sign-in-alt"></i> Join School</button>
      </form>
    </div>
  </div>

  <!-- Register School Full Screen Form -->
  <div class="full-screen-form" id="registerSchoolForm" style="display:none;">
    <button class="close-form" id="closeRegisterForm"><i class="fas fa-times"></i></button>
    <div class="container">
      <div class="header">
        <h2>Register a School</h2>
        <p>Create a new school on Skore Point</p>
      </div>

      <div id="registerSchoolError" class="alert error" style="display:none;">
        <i class="fas fa-exclamation-circle"></i>
        <span></span>
      </div>
      <div id="registerSchoolSuccess" class="alert success" style="display:none;">
        <i class="fas fa-check-circle"></i>
        <span>School registered successfully!</span>
      </div>

      <form id="registerSchoolFormFields">
        <div class="form-group">
          <label><i class="fas fa-school"></i> School Name</label>
          <input type="text" id="registerSchoolName" placeholder="Enter school name" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-map-marker-alt"></i> School Location</label>
          <input type="text" id="registerSchoolLocation" placeholder="Enter school location" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-phone"></i> School Phone</label>
          <input type="tel" id="registerSchoolPhone" placeholder="Enter school phone number" required>
        </div>
        <div class="form-group">
          <label><i class="fas fa-graduation-cap"></i> School Level</label>
          <select id="registerSchoolLevel" required>
            <option value="">Select School Level</option>
            <option value="primary">Primary School</option>
            <option value="secondary">Secondary School</option>
          </select>
        </div>
        <div class="logo-upload" id="logoUploadArea">
          <i class="fas fa-image"></i>
          <p>Upload School Logo</p>
          <span>Click to upload. Recommended size: 200x200px</span>
          <div class="logo-preview" id="logoPreview">
            <img id="logoPreviewImg" src="" alt="Logo Preview">
          </div>
          <button type="button" class="btn btn-secondary" id="uploadLogoBtn"><i class="fas fa-upload"></i> Upload Logo</button>
          <input type="hidden" id="logoUrl">
        </div>
        <button class="btn btn-primary" type="submit"><i class="fas fa-plus-circle"></i> Register School</button>
      </form>
    </div>
  </div>

  <!-- SCHOOL MANAGEMENT SECTION -->
  <div class="school-management" id="schoolManagementSection" style="display:none;">
    <div class="dashboard-top-section">
      <h1>Home</h1>
      <div class="logo">SKORE POINT</div>
    </div>

    <div class="management-tabs" id="managementTabs" style="display:none;">
      <div class="tab tab-disabled" data-tab="classes">Classes</div>
      <div class="tab tab-disabled" data-tab="students">Students</div>
      <div class="tab tab-disabled" data-tab="subjects">Subjects</div>
      <div class="tab tab-disabled" data-tab="marks">Enter Marks</div>
      <div class="tab tab-disabled" data-tab="reports">Reports</div>
    </div>

    <!-- Content will be displayed in overlay -->
  </div>

  <!-- Overlay Content for Tabs -->
  <div class="overlay-content" id="classesOverlay">
    <div class="overlay-header">
      <h2>Manage Classes</h2>
      <button class="close-overlay" id="closeClassesOverlay"><i class="fas fa-times"></i></button>
    </div>
    <div class="container">
      <form id="addClassForm">
        <div class="form-group">
          <label><i class="fas fa-chalkboard"></i> Class Name</label>
          <input type="text" id="className" placeholder="e.g., Grade 5A, Form 3, etc." required>
        </div>
        <button class="btn btn-primary" type="submit"><i class="fas fa-plus"></i> Add Class</button>
      </form>

      <div class="class-list" id="classList">
        <!-- Classes will be populated here -->
      </div>
    </div>
  </div>

  <div class="overlay-content" id="studentsOverlay">
    <div class="overlay-header">
      <h2>Manage Students</h2>
      <button class="close-overlay" id="closeStudentsOverlay"><i class="fas fa-times"></i></button>
    </div>
    <div class="container">
      <div class="form-group">
        <label><i class="fas fa-chalkboard"></i> Select Class</label>
        <select id="studentClassSelect">
          <option value="">Select a class</option>
        </select>
      </div>

      <div class="file-upload" id="studentUploadArea">
        <i class="fas fa-file-excel"></i>
        <p>Upload Excel File with Student Names</p>
        <span>Click or drag & drop to upload. First column should contain student names.</span>
        <input type="file" id="studentFile" accept=".xlsx,.xls" style="display:none;">
      </div>

      <div id="studentUploadError" class="alert error" style="display:none;">
        <i class="fas fa-exclamation-circle"></i>
        <span></span>
      </div>

      <div id="studentUploadSuccess" class="alert success" style="display:none;">
        <i class="fas fa-check-circle"></i>
        <span>Students uploaded successfully!</span>
      </div>

      <div class="student-list" id="studentList">
        <!-- Students will be populated here -->
      </div>
    </div>
  </div>

  <div class="overlay-content" id="subjectsOverlay">
    <div class="overlay-header">
      <h2>Manage Subjects</h2>
      <button class="close-overlay" id="closeSubjectsOverlay"><i class="fas fa-times"></i></button>
    </div>
    <div class="container">
      <form id="addSubjectForm">
        <div class="form-group">
          <label><i class="fas fa-book"></i> Subject Name</label>
          <input type="text" id="subjectName" placeholder="Enter subject name" required>
        </div>
        <button class="btn btn-primary" type="submit"><i class="fas fa-plus"></i> Add Subject</button>
      </form>

      <div class="subjects-list" id="subjectsList">
        <!-- Subjects will be populated here -->
      </div>
    </div>
  </div>

  <div class="overlay-content" id="marksOverlay">
    <div class="overlay-header">
      <h2>Enter Student Marks</h2>
      <button class="close-overlay" id="closeMarksOverlay"><i class="fas fa-times"></i></button>
    </div>
    <div class="container">
      <div class="form-group">
        <label><i class="fas fa-chalkboard"></i> Select Class</label>
        <select id="marksClassSelect">
          <option value="">Select a class</option>
        </select>
      </div>

      <div class="form-group">
        <label><i class="fas fa-calendar-alt"></i> Term</label>
        <select id="termSelect" required>
          <option value="">Select Term</option>
          <option value="beginning">Beginning of Term</option>
          <option value="mid">Mid Term</option>
          <option value="end">End of Term</option>
        </select>
      </div>

      <div class="marks-entry" id="marksEntrySection" style="display:none;">
        <h3>Enter Marks</h3>
        
        <div class="form-group student-selector">
          <label><i class="fas fa-user"></i> Student Name</label>
          <input type="text" id="studentSearch" placeholder="Start typing student name..." autocomplete="off">
          <div class="student-suggestions" id="studentSuggestions">
            <!-- Student suggestions will appear here -->
          </div>
        </div>

        <div id="currentStudentInfo" style="display:none; margin-bottom: 20px; padding: 15px; background: var(--gray); border-radius: 8px;">
          <h4>Selected Student: <span id="selectedStudentName"></span></h4>
          <p style="font-size: 14px; color: #a0aec0; margin-top: 5px;">Enter marks for each subject below</p>
        </div>

        <div class="marks-grid" id="marksGrid">
          <!-- Mark inputs will be generated here -->
        </div>

        <div id="marksAlert" class="alert" style="display:none;">
          <i class="fas fa-info-circle"></i>
          <span></span>
        </div>

        <button class="btn btn-primary" id="saveMarksBtn" disabled><i class="fas fa-save"></i> Save Marks</button>
      </div>
    </div>
  </div>

  <div class="overlay-content" id="reportsOverlay">
    <div class="overlay-header">
      <h2>Generate Reports</h2>
      <button class="close-overlay" id="closeReportsOverlay"><i class="fas fa-times"></i></button>
    </div>
    <div class="container">
      <div class="report-filters">
        <h4 style="margin-bottom: 15px;">Report Filters</h4>
        <div class="filter-grid">
          <div class="form-group">
            <label><i class="fas fa-chalkboard"></i> Select Class</label>
            <select id="reportClassSelect">
              <option value="">All Classes</option>
            </select>
          </div>
          <div class="form-group">
            <label><i class="fas fa-user"></i> Select Student</label>
            <select id="reportStudentSelect">
              <option value="">All Students</option>
            </select>
          </div>
          <div class="form-group">
            <label><i class="fas fa-calendar-alt"></i> Select Term</label>
            <select id="reportTermSelect">
              <option value="beginning">Beginning of Term</option>
              <option value="mid">Mid Term</option>
              <option value="end" selected>End of Term</option>
            </select>
          </div>
        </div>
        <div class="report-actions">
          <button class="btn btn-primary" id="generateReportBtn"><i class="fas fa-chart-bar"></i> Generate Report</button>
          <button class="btn btn-success" id="exportPDFBtn"><i class="fas fa-file-pdf"></i> Export PDF</button>
          <button class="btn btn-warning" id="exportExcelBtn"><i class="fas fa-file-excel"></i> Export Excel</button>
        </div>
      </div>

      <div class="stats-grid" id="statsGrid" style="display:none;">
        <div class="stat-card">
          <h4>Total Students</h4>
          <p id="statTotalStudents">0</p>
        </div>
        <div class="stat-card">
          <h4>Average Score</h4>
          <p id="statAvgScore">0</p>
        </div>
        <div class="stat-card">
          <h4>Highest Score</h4>
          <p id="statHighScore">0</p>
        </div>
        <div class="stat-card">
          <h4>Lowest Score</h4>
          <p id="statLowScore">0</p>
        </div>
      </div>

      <div class="report-preview" id="reportPreview" style="display:none;">
        <h3>Report Preview</h3>
        <div class="report-card-layout">
          <div class="report-card-section">
            <h3>Subjects</h3>
            <table class="report-table" id="subjectsTable">
              <thead>
                <tr>
                  <th>Subject</th>
                </tr>
              </thead>
              <tbody id="subjectsTableBody">
                <!-- Subjects will be populated here -->
              </tbody>
            </table>
          </div>
          <div class="report-card-section">
            <h3>Scores</h3>
            <table class="report-table" id="scoresTable">
              <thead>
                <tr>
                  <th>Score</th>
                </tr>
              </thead>
              <tbody id="scoresTableBody">
                <!-- Scores will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="remarks-section">
          <div class="form-group">
            <label><i class="fas fa-comment"></i> Teacher's Remarks</label>
            <textarea id="teacherRemarks" placeholder="Enter teacher's remarks"></textarea>
          </div>
          <div class="form-group">
            <label><i class="fas fa-user-tie"></i> Head Teacher's Remarks</label>
            <textarea id="headTeacherRemarks" placeholder="Enter head teacher's remarks"></textarea>
          </div>
        </div>
      </div>

      <div class="empty-state" id="reportsEmptyState">
        <i class="fas fa-chart-line"></i>
        <h3>No Data Available</h3>
        <p>Please add students and marks to generate reports</p>
      </div>
    </div>
  </div>

  <!-- MOBILE NAVIGATION -->
  <div class="mobile-nav" id="mobileNav" style="display:none;">
    <div class="mobile-nav-items">
      <a href="#" class="mobile-nav-item active" data-section="dashboard">
        <i class="fas fa-home"></i>
        <span>Home</span>
      </a>
      <a href="#" class="mobile-nav-item tab-disabled" data-section="classes">
        <i class="fas fa-chalkboard"></i>
        <span>Classes</span>
      </a>
      <a href="#" class="mobile-nav-item tab-disabled" data-section="students">
        <i class="fas fa-users"></i>
        <span>Students</span>
      </a>
      <a href="#" class="mobile-nav-item tab-disabled" data-section="marks">
        <i class="fas fa-edit"></i>
        <span>Marks</span>
      </a>
      <a href="#" class="mobile-nav-item tab-disabled" data-section="reports">
        <i class="fas fa-chart-bar"></i>
        <span>Reports</span>
      </a>
    </div>
  </div>

<script>
  // Cloudinary Configuration
  const CLOUDINARY_CLOUD_NAME = 'dbtucc6v2';
  const CLOUDINARY_UPLOAD_PRESET = 'gradeforcus';

  // DOM Elements
  const launchScreen = document.getElementById('launchScreen');
  const loginSection = document.getElementById('loginSection');
  const registerSection = document.getElementById('registerSection');
  const dashboardSection = document.getElementById('dashboardSection');
  const schoolSetupSection = document.getElementById('schoolSetupSection');
  const schoolManagementSection = document.getElementById('schoolManagementSection');
  const mobileNav = document.getElementById('mobileNav');
  const managementTabs = document.getElementById('managementTabs');
  
  // Navigation buttons
  const goRegister = document.getElementById('goRegister');
  const goLogin = document.getElementById('goLogin');
  const joinSchoolCard = document.getElementById('joinSchoolCard');
  const registerSchoolCard = document.getElementById('registerSchoolCard');
  const manageSchoolCard = document.getElementById('manageSchoolCard');
  const joinSchoolOption = document.getElementById('joinSchoolOption');
  const registerSchoolOption = document.getElementById('registerSchoolOption');
  const joinSchoolForm = document.getElementById('joinSchoolForm');
  const registerSchoolForm = document.getElementById('registerSchoolForm');
  const closeJoinForm = document.getElementById('closeJoinForm');
  const closeRegisterForm = document.getElementById('closeRegisterForm');
  const openPortalBtn = document.getElementById('openPortalBtn');
  
  // Form elements
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const joinSchoolFormFields = document.getElementById('joinSchoolFormFields');
  const registerSchoolFormFields = document.getElementById('registerSchoolFormFields');
  const addClassForm = document.getElementById('addClassForm');
  const addSubjectForm = document.getElementById('addSubjectForm');
  
  // Overlay elements
  const classesOverlay = document.getElementById('classesOverlay');
  const studentsOverlay = document.getElementById('studentsOverlay');
  const subjectsOverlay = document.getElementById('subjectsOverlay');
  const marksOverlay = document.getElementById('marksOverlay');
  const reportsOverlay = document.getElementById('reportsOverlay');
  
  const closeClassesOverlay = document.getElementById('closeClassesOverlay');
  const closeStudentsOverlay = document.getElementById('closeStudentsOverlay');
  const closeSubjectsOverlay = document.getElementById('closeSubjectsOverlay');
  const closeMarksOverlay = document.getElementById('closeMarksOverlay');
  const closeReportsOverlay = document.getElementById('closeReportsOverlay');
  
  // User info
  const userName = document.getElementById('userName');
  const currentSchoolName = document.getElementById('currentSchoolName');
  const currentSchoolCode = document.getElementById('currentSchoolCode');
  
  // School card info
  const schoolCardName = document.getElementById('schoolCardName');
  const schoolCardCode = document.getElementById('schoolCardCode');
  const schoolCardLogo = document.getElementById('schoolCardLogo');
  
  // Global variables
  let currentUser = null;
  let currentSchool = null;
  let currentClasses = [];
  let currentStudents = [];
  let currentSubjects = [];
  let selectedStudentId = null;
  let currentMarks = {};
  let schoolLogoUrl = null;
  let userProfileUrl = null;
  let portalOpened = false;

  // Default subjects for different school levels
  const DEFAULT_SUBJECTS = {
    primary: ['Mathematics', 'English', 'Integrated Science', 'Social Studies'],
    secondary: [
      'English Language', 'Literature', 'Mathematics', 'Biology', 'Chemistry', 
      'Physics', 'Geography', 'History & Political Education', 'Religious Education',
      'Islamic', 'Kiswahili', 'Entrepreneurship Education', 'Agriculture',
      'Computer / ICT Studies', 'Fine Art / Art & Design', 'Physical Education (PE)',
      'Luganda', 'French', 'Technology & Design'
    ]
  };

  // Grading scales
  const GRADING_SCALES = {
    primary: ['D1', 'D2', 'C3', 'C4', 'C5', 'C6', 'P7', 'P8', 'F9'],
    secondary: ['A', 'B', 'C', 'D', 'E']
  };

  // Initialize the app
  document.addEventListener('DOMContentLoaded', () => {
    // Show launch screen first
    showSection(launchScreen);
    
    // After 3 seconds, check authentication and show appropriate section
    setTimeout(() => {
      // Check if user is already logged in
      if (window.firebase && window.firebase.auth) {
        window.firebase.onAuthStateChanged(window.firebase.auth, (user) => {
          if (user) {
            currentUser = user;
            loadUserData(user.uid);
            showSection(dashboardSection);
          } else {
            showSection(loginSection);
          }
        });
      } else {
        // If Firebase is not loaded, show login screen
        console.error("Firebase not loaded properly");
        showSection(loginSection);
      }
    }, 3000);

    // Setup event listeners
    setupEventListeners();
  });

  // Load user data from Firestore
  async function loadUserData(userId) {
    try {
      const userDoc = await window.firebase.getDoc(
        window.firebase.doc(window.firebase.db, 'users', userId)
      );
      
      if (userDoc.exists()) {
        const userData = userDoc.data();
        userName.textContent = userData.name || userData.email;
        
        // Load profile picture if available
        if (userData.profilePicture) {
          document.getElementById('profilePreview').src = userData.profilePicture;
          userProfileUrl = userData.profilePicture;
        }
        
        // Check if user has a school
        if (userData.schoolId) {
          await loadSchoolData(userData.schoolId);
        }
      }
    } catch (error) {
      console.error('Error loading user data:', error);
    }
  }

  // Load school data from Firestore
  async function loadSchoolData(schoolId) {
    try {
      const schoolDoc = await window.firebase.getDoc(
        window.firebase.doc(window.firebase.db, 'schools', schoolId)
      );
      
      if (schoolDoc.exists()) {
        currentSchool = {
          id: schoolDoc.id,
          ...schoolDoc.data()
        };
        
        currentSchoolName.textContent = currentSchool.name;
        currentSchoolCode.textContent = currentSchool.code;
        document.getElementById('schoolInfo').style.display = 'block';
        manageSchoolCard.style.display = 'block';
        
        // Update school card info
        schoolCardName.textContent = currentSchool.name;
        schoolCardCode.textContent = currentSchool.code;
        
        // Load school logo if available
        if (currentSchool.logoUrl) {
          schoolLogoUrl = currentSchool.logoUrl;
          schoolCardLogo.src = currentSchool.logoUrl;
          schoolCardLogo.style.display = 'block';
        }
        
        // Load school data
        await loadClasses();
        await loadSubjects();
      }
    } catch (error) {
      console.error('Error loading school data:', error);
    }
  }

  // Setup all event listeners
  function setupEventListeners() {
    // Navigation
    goRegister.onclick = () => showSection(registerSection);
    goLogin.onclick = () => showSection(loginSection);
    joinSchoolCard.onclick = () => showJoinSchoolForm();
    registerSchoolCard.onclick = () => showRegisterSchoolForm();
    manageSchoolCard.onclick = () => showSchoolManagement();
    joinSchoolOption.onclick = () => showJoinSchoolForm();
    registerSchoolOption.onclick = () => showRegisterSchoolForm();
    closeJoinForm.onclick = () => hideFullScreenForm();
    closeRegisterForm.onclick = () => hideFullScreenForm();
    openPortalBtn.onclick = () => openPortal();

    // Form submissions
    loginForm.onsubmit = handleLogin;
    registerForm.onsubmit = handleRegister;
    joinSchoolFormFields.onsubmit = handleJoinSchool;
    registerSchoolFormFields.onsubmit = handleRegisterSchool;
    addClassForm.onsubmit = handleAddClass;
    addSubjectForm.onsubmit = handleAddSubject;

    // Password toggles
    setupPasswordToggles();

    // File upload
    setupFileUpload();

    // Logo upload
    document.getElementById('uploadLogoBtn').onclick = () => openCloudinaryUpload('logo');
    
    // Profile picture upload
    document.getElementById('uploadProfileBtn').onclick = () => openCloudinaryUpload('profile');

    // Tab switching
    setupTabs();

    // Student search
    setupStudentSearch();

    // Marks saving
    document.getElementById('saveMarksBtn').onclick = handleSaveMarks;

    // Report generation
    document.getElementById('generateReportBtn').onclick = generateReport;
    document.getElementById('exportPDFBtn').onclick = exportToPDF;
    document.getElementById('exportExcelBtn').onclick = exportToExcel;
    document.getElementById('reportClassSelect').onchange = updateStudentDropdown;

    // Mobile navigation
    setupMobileNavigation();

    // Overlay close buttons
    closeClassesOverlay.onclick = () => hideOverlay('classesOverlay');
    closeStudentsOverlay.onclick = () => hideOverlay('studentsOverlay');
    closeSubjectsOverlay.onclick = () => hideOverlay('subjectsOverlay');
    closeMarksOverlay.onclick = () => hideOverlay('marksOverlay');
    closeReportsOverlay.onclick = () => hideOverlay('reportsOverlay');
  }

  // Open Cloudinary upload widget
  function openCloudinaryUpload(type) {
    const widget = cloudinary.createUploadWidget({
      cloudName: CLOUDINARY_CLOUD_NAME,
      uploadPreset: CLOUDINARY_UPLOAD_PRESET,
      sources: ['local', 'url'],
      multiple: false,
      maxFiles: 1,
      cropping: type === 'profile',
      croppingAspectRatio: type === 'profile' ? 1 : null,
      showAdvancedOptions: false,
      styles: {
        palette: {
          window: "#1C1C1C",
          sourceBg: "#2D2D2D",
          windowBorder: "#4A4A4A",
          tabIcon: "#FFFFFF",
          inactiveTabIcon: "#8E8E8E",
          menuIcons: "#FFFFFF",
          link: "#4361EE",
          action: "#4361EE",
          inProgress: "#4361EE",
          complete: "#38A169",
          error: "#E53E3E",
          textDark: "#121212",
          textLight: "#FFFFFF"
        }
      }
    }, (error, result) => {
      if (!error && result && result.event === "success") {
        if (type === 'logo') {
          document.getElementById('logoPreviewImg').src = result.info.secure_url;
          document.getElementById('logoPreview').style.display = 'block';
          document.getElementById('logoUrl').value = result.info.secure_url;
          schoolLogoUrl = result.info.secure_url;
        } else if (type === 'profile') {
          document.getElementById('profilePreview').src = result.info.secure_url;
          document.getElementById('profilePictureUrl').value = result.info.secure_url;
          userProfileUrl = result.info.secure_url;
        }
      }
    });
    
    widget.open();
  }

  // Show specific section and hide others
  function showSection(section) {
    [launchScreen, loginSection, registerSection, dashboardSection, schoolSetupSection, schoolManagementSection].forEach(sec => {
      sec.style.display = 'none';
    });
    section.style.display = 'block';
    
    // Show/hide mobile nav based on section
    if (section === dashboardSection || section === schoolManagementSection) {
      mobileNav.style.display = 'block';
    } else {
      mobileNav.style.display = 'none';
    }
  }

  // Show join school form in full screen
  function showJoinSchoolForm() {
    joinSchoolForm.style.display = 'block';
  }

  // Show register school form in full screen
  function showRegisterSchoolForm() {
    registerSchoolForm.style.display = 'block';
  }

  // Hide full screen form
  function hideFullScreenForm() {
    joinSchoolForm.style.display = 'none';
    registerSchoolForm.style.display = 'none';
  }

  // Show school management section
  async function showSchoolManagement() {
    showSection(schoolManagementSection);
    
    // Show management tabs only if school is managed
    if (currentSchool) {
      managementTabs.style.display = 'flex';
    }
    
    await loadClasses();
    await loadSubjects();
    populateClassSelectors();
  }

  // Open portal and enable tabs
  function openPortal() {
    portalOpened = true;
    
    // Enable all tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.classList.remove('tab-disabled');
    });
    
    // Enable mobile nav items
    document.querySelectorAll('.mobile-nav-item').forEach(item => {
      item.classList.remove('tab-disabled');
    });
    
    // Show management tabs if not already shown
    managementTabs.style.display = 'flex';
  }

  // Setup password visibility toggles
  function setupPasswordToggles() {
    const togglePassword = (btn, field) => {
      btn.addEventListener('click', () => {
        const type = field.type === 'password' ? 'text' : 'password';
        field.type = type;
        btn.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
      });
    };

    togglePassword(document.getElementById('loginToggle'), document.getElementById('loginPassword'));
    togglePassword(document.getElementById('registerToggle'), document.getElementById('regPassword'));
    togglePassword(document.getElementById('confirmToggle'), document.getElementById('confirmPassword'));
  }

  // Setup file upload for students
  function setupFileUpload() {
    const uploadArea = document.getElementById('studentUploadArea');
    const fileInput = document.getElementById('studentFile');

    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = 'var(--primary)';
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.style.borderColor = 'var(--gray)';
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = 'var(--gray)';
      if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        handleStudentUpload();
      }
    });

    fileInput.addEventListener('change', handleStudentUpload);
  }

  // Setup tab switching
  function setupTabs() {
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        if (tab.classList.contains('tab-disabled')) return;
        
        // Remove active class from all tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        
        // Add active class to clicked tab
        tab.classList.add('active');
        
        // Show corresponding overlay
        showOverlay(`${tab.dataset.tab}Overlay`);
      });
    });
  }

  // Show overlay
  function showOverlay(overlayId) {
    document.getElementById(overlayId).style.display = 'block';
  }

  // Hide overlay
  function hideOverlay(overlayId) {
    document.getElementById(overlayId).style.display = 'none';
  }

  // Setup mobile navigation
  function setupMobileNavigation() {
    const navItems = document.querySelectorAll('.mobile-nav-item');
    
    navItems.forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        
        if (item.classList.contains('tab-disabled')) return;
        
        // Remove active class from all items
        navItems.forEach(navItem => navItem.classList.remove('active'));
        
        // Add active class to clicked item
        item.classList.add('active');
        
        const section = item.dataset.section;
        
        if (section === 'dashboard') {
          showSection(dashboardSection);
        } else {
          // Switch to school management and activate the corresponding tab
          showSection(schoolManagementSection);
          
          // Remove active class from all tabs
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          
          // Add active class to the selected tab
          const tab = document.querySelector(`.tab[data-tab="${section}"]`);
          if (tab) {
            tab.classList.add('active');
            
            // Show corresponding overlay
            showOverlay(`${section}Overlay`);
          }
        }
      });
    });
  }

  // Setup student search for marks entry
  function setupStudentSearch() {
    const studentSearch = document.getElementById('studentSearch');
    const suggestions = document.getElementById('studentSuggestions');

    studentSearch.addEventListener('input', () => {
      const searchTerm = studentSearch.value.toLowerCase();
      const classId = document.getElementById('marksClassSelect').value;
      
      if (!classId || searchTerm.length < 2) {
        suggestions.style.display = 'none';
        return;
      }

      // Filter students by class and search term
      const filteredStudents = currentStudents.filter(student => 
        student.classId === classId && 
        student.name.toLowerCase().includes(searchTerm)
      );

      // Display suggestions
      suggestions.innerHTML = '';
      if (filteredStudents.length > 0) {
        filteredStudents.forEach(student => {
          const div = document.createElement('div');
          div.className = 'student-suggestion';
          div.textContent = student.name;
          div.addEventListener('click', async () => {
            studentSearch.value = student.name;
            suggestions.style.display = 'none';
            selectedStudentId = student.id;
            document.getElementById('selectedStudentName').textContent = student.name;
            document.getElementById('currentStudentInfo').style.display = 'block';
            document.getElementById('saveMarksBtn').disabled = false;
            await loadStudentMarks(student.id);
          });
          suggestions.appendChild(div);
        });
        suggestions.style.display = 'block';
      } else {
        suggestions.style.display = 'none';
      }
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', (e) => {
      if (!studentSearch.contains(e.target) && !suggestions.contains(e.target)) {
        suggestions.style.display = 'none';
      }
    });
  }

  // Setup marks entry section
  function setupMarksEntry() {
    const classSelect = document.getElementById('marksClassSelect');
    const marksSection = document.getElementById('marksEntrySection');
    
    classSelect.addEventListener('change', () => {
      if (classSelect.value) {
        marksSection.style.display = 'block';
        generateMarkInputs();
        document.getElementById('studentSearch').value = '';
        document.getElementById('currentStudentInfo').style.display = 'none';
        selectedStudentId = null;
        document.getElementById('saveMarksBtn').disabled = true;
      } else {
        marksSection.style.display = 'none';
      }
    });
  }

  // Generate mark input fields based on subjects
  function generateMarkInputs() {
    const marksGrid = document.getElementById('marksGrid');
    marksGrid.innerHTML = '';
    
    currentSubjects.forEach(subject => {
      const div = document.createElement('div');
      div.className = 'mark-input';
      div.innerHTML = `
        <label>${subject.name}</label>
        <input type="number" min="0" max="100" placeholder="0-100" data-subject="${subject.id}">
      `;
      marksGrid.appendChild(div);
    });
  }

  // Load student marks if they exist
  async function loadStudentMarks(studentId) {
    try {
      const term = document.getElementById('termSelect').value;
      const marksDoc = await window.firebase.getDoc(
        window.firebase.doc(window.firebase.db, 'marks', `${studentId}_${term}`)
      );
      
      if (marksDoc.exists()) {
        const marks = marksDoc.data();
        currentSubjects.forEach(subject => {
          const input = document.querySelector(`input[data-subject="${subject.id}"]`);
          if (input && marks[subject.id] !== undefined) {
            input.value = marks[subject.id];
          } else {
            input.value = '';
          }
        });
      } else {
        // Clear all inputs
        document.querySelectorAll('.mark-input input').forEach(input => {
          input.value = '';
        });
      }
    } catch (error) {
      console.error('Error loading marks:', error);
    }
  }

  // Handle saving marks
  async function handleSaveMarks() {
    if (!selectedStudentId) {
      showMarksAlert('Please select a student first', 'error');
      return;
    }

    const term = document.getElementById('termSelect').value;
    if (!term) {
      showMarksAlert('Please select a term', 'error');
      return;
    }

    const marks = {};
    let hasMarks = false;
    
    currentSubjects.forEach(subject => {
      const input = document.querySelector(`input[data-subject="${subject.id}"]`);
      const value = parseInt(input.value);
      if (!isNaN(value) && value >= 0 && value <= 100) {
        marks[subject.id] = value;
        hasMarks = true;
      }
    });

    if (!hasMarks) {
      showMarksAlert('Please enter at least one mark', 'warning');
      return;
    }

    try {
      // Save marks to Firestore
      await window.firebase.setDoc(
        window.firebase.doc(window.firebase.db, 'marks', `${selectedStudentId}_${term}`),
        {
          studentId: selectedStudentId,
          schoolId: currentSchool.id,
          term: term,
          ...marks,
          updatedAt: new Date()
        }
      );

      showMarksAlert('Marks saved successfully!', 'success');
      
      // Clear form after a delay
      setTimeout(() => {
        document.getElementById('studentSearch').value = '';
        document.getElementById('currentStudentInfo').style.display = 'none';
        selectedStudentId = null;
        document.getElementById('saveMarksBtn').disabled = true;
        document.querySelectorAll('.mark-input input').forEach(input => {
          input.value = '';
        });
      }, 1500);
    } catch (error) {
      console.error('Error saving marks:', error);
      showMarksAlert('Error saving marks. Please try again.', 'error');
    }
  }

  // Show alert in marks section
  function showMarksAlert(message, type) {
    const alert = document.getElementById('marksAlert');
    alert.className = `alert ${type}`;
    alert.querySelector('span').textContent = message;
    alert.style.display = 'flex';
    
    setTimeout(() => {
      alert.style.display = 'none';
    }, 3000);
  }

  // Setup reports tab
  async function setupReportsTab() {
    await populateReportClassSelector();
    document.getElementById('reportsEmptyState').style.display = 'block';
    document.getElementById('reportPreview').style.display = 'none';
    document.getElementById('statsGrid').style.display = 'none';
  }

  // Populate class selector in reports
  async function populateReportClassSelector() {
    const select = document.getElementById('reportClassSelect');
    while (select.options.length > 1) {
      select.remove(1);
    }
    
    currentClasses.forEach(classObj => {
      const option = document.createElement('option');
      option.value = classObj.id;
      option.textContent = classObj.name;
      select.appendChild(option);
    });
  }

  // Update student dropdown based on selected class
  async function updateStudentDropdown() {
    const classId = document.getElementById('reportClassSelect').value;
    const select = document.getElementById('reportStudentSelect');
    
    // Clear existing options except first one
    while (select.options.length > 1) {
      select.remove(1);
    }
    
    if (!classId) return;
    
    const classStudents = currentStudents.filter(s => s.classId === classId);
    classStudents.forEach(student => {
      const option = document.createElement('option');
      option.value = student.id;
      option.textContent = student.name;
      select.appendChild(option);
    });
  }

  // Generate report
  async function generateReport() {
    const classId = document.getElementById('reportClassSelect').value;
    const studentId = document.getElementById('reportStudentSelect').value;
    const term = document.getElementById('reportTermSelect').value;
    
    try {
      // Get all marks from Firestore
      const marksQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'marks'),
        window.firebase.where('schoolId', '==', currentSchool.id),
        window.firebase.where('term', '==', term)
      );
      
      const marksSnapshot = await window.firebase.getDocs(marksQuery);
      const allMarks = [];
      
      marksSnapshot.forEach(doc => {
        allMarks.push({
          id: doc.id,
          ...doc.data()
        });
      });

      // Filter based on selection
      let filteredData = allMarks;
      
      if (classId) {
        const classStudents = currentStudents.filter(s => s.classId === classId);
        const studentIds = classStudents.map(s => s.id);
        filteredData = filteredData.filter(mark => studentIds.includes(mark.studentId));
      }
      
      if (studentId) {
        filteredData = filteredData.filter(mark => mark.studentId === studentId);
      }

      if (filteredData.length === 0) {
        document.getElementById('reportsEmptyState').style.display = 'block';
        document.getElementById('reportPreview').style.display = 'none';
        document.getElementById('statsGrid').style.display = 'none';
        return;
      }

      // Display report
      displayReport(filteredData);
      calculateStatistics(filteredData);
      
      document.getElementById('reportsEmptyState').style.display = 'none';
      document.getElementById('reportPreview').style.display = 'block';
      document.getElementById('statsGrid').style.display = 'grid';
    } catch (error) {
      console.error('Error generating report:', error);
      alert('Error generating report. Please try again.');
    }
  }

  // Display report in table
  function displayReport(data) {
    const subjectsBody = document.getElementById('subjectsTableBody');
    const scoresBody = document.getElementById('scoresTableBody');
    subjectsBody.innerHTML = '';
    scoresBody.innerHTML = '';
    
    // For simplicity, we'll show the first student's data
    if (data.length === 0) return;
    
    const mark = data[0];
    const student = currentStudents.find(s => s.id === mark.studentId);
    if (!student) return;
    
    let total = 0;
    let count = 0;
    
    currentSubjects.forEach(subject => {
      const score = mark[subject.id] || 0;
      total += score;
      count++;
      
      // Add to subjects table
      const subjectRow = document.createElement('tr');
      subjectRow.innerHTML = `<td>${subject.name}</td>`;
      subjectsBody.appendChild(subjectRow);
      
      // Add to scores table
      const scoreRow = document.createElement('tr');
      scoreRow.innerHTML = `<td>${score > 0 ? score : '-'}</td>`;
      scoresBody.appendChild(scoreRow);
    });
    
    // Add total and average rows
    const average = count > 0 ? Math.round(total / count) : 0;
    
    const totalSubjectRow = document.createElement('tr');
    totalSubjectRow.innerHTML = `<td><strong>TOTAL</strong></td>`;
    subjectsBody.appendChild(totalSubjectRow);
    
    const totalScoreRow = document.createElement('tr');
    totalScoreRow.innerHTML = `<td><strong>${total}</strong></td>`;
    scoresBody.appendChild(totalScoreRow);
    
    const avgSubjectRow = document.createElement('tr');
    avgSubjectRow.innerHTML = `<td><strong>AVERAGE</strong></td>`;
    subjectsBody.appendChild(avgSubjectRow);
    
    const avgScoreRow = document.createElement('tr');
    avgScoreRow.innerHTML = `<td><strong>${average}</strong></td>`;
    scoresBody.appendChild(avgScoreRow);
  }

  // Calculate statistics
  function calculateStatistics(data) {
    let totalStudents = data.length;
    let allScores = [];
    
    data.forEach(mark => {
      let total = 0;
      let count = 0;
      
      currentSubjects.forEach(subject => {
        if (mark[subject.id] !== undefined) {
          total += mark[subject.id];
          count++;
        }
      });
      
      if (count > 0) {
        allScores.push(total / count);
      }
    });
    
    const avgScore = allScores.length > 0 ? Math.round(allScores.reduce((a, b) => a + b, 0) / allScores.length) : 0;
    const highScore = allScores.length > 0 ? Math.round(Math.max(...allScores)) : 0;
    const lowScore = allScores.length > 0 ? Math.round(Math.min(...allScores)) : 0;
    
    document.getElementById('statTotalStudents').textContent = totalStudents;
    document.getElementById('statAvgScore').textContent = avgScore;
    document.getElementById('statHighScore').textContent = highScore;
    document.getElementById('statLowScore').textContent = lowScore;
  }

  // Export to PDF with individual student reports
  async function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Get the selected class and student
    const classId = document.getElementById('reportClassSelect').value;
    const studentId = document.getElementById('reportStudentSelect').value;
    const term = document.getElementById('reportTermSelect').value;
    
    // Get all marks from Firestore
    const marksQuery = window.firebase.query(
      window.firebase.collection(window.firebase.db, 'marks'),
      window.firebase.where('schoolId', '==', currentSchool.id),
      window.firebase.where('term', '==', term)
    );
    
    const marksSnapshot = await window.firebase.getDocs(marksQuery);
    const allMarks = [];
    
    marksSnapshot.forEach(doc => {
      allMarks.push({
        id: doc.id,
        ...doc.data()
      });
    });

    // Filter based on selection
    let filteredData = allMarks;
    
    if (classId) {
      const classStudents = currentStudents.filter(s => s.classId === classId);
      const studentIds = classStudents.map(s => s.id);
      filteredData = filteredData.filter(mark => studentIds.includes(mark.studentId));
    }
    
    if (studentId) {
      filteredData = filteredData.filter(mark => mark.studentId === studentId);
    }

    // Generate individual report for each student
    for (let i = 0; i < filteredData.length; i++) {
      const mark = filteredData[i];
      if (i > 0) {
        doc.addPage();
      }
      
      const student = currentStudents.find(s => s.id === mark.studentId);
      if (!student) continue;
      
      const classObj = currentClasses.find(c => c.id === student.classId);
      
      // Add header with logo and school name
      doc.setFontSize(20);
      doc.setTextColor(67, 97, 238);
      doc.text('Skore Point', 20, 30);
      doc.setFontSize(12);
      doc.setTextColor(100, 100, 100);
      doc.text('skorepoint.com', 20, 38);
      doc.text('A product of SERUSOFT', 20, 45);
      
      // Add school logo if available
      if (schoolLogoUrl) {
        try {
          // Create an image element to load the logo
          const logoImg = new Image();
          logoImg.crossOrigin = 'Anonymous';
          logoImg.src = schoolLogoUrl;
          
          // Wait for the image to load
          await new Promise((resolve) => {
            logoImg.onload = resolve;
            logoImg.onerror = resolve; // Continue even if image fails to load
          });
          
          // Add the logo to the PDF
          doc.addImage(logoImg, 'JPEG', 150, 20, 40, 40);
        } catch (error) {
          console.error('Error adding logo to PDF:', error);
          // Fallback: Add a placeholder if logo fails to load
          doc.setFillColor(200, 200, 200);
          doc.rect(150, 20, 40, 40, 'F');
          doc.setTextColor(100, 100, 100);
          doc.text('School Logo', 155, 45);
        }
      }
      
      // Add school name and info
      doc.setFontSize(16);
      doc.setTextColor(0, 0, 0);
      doc.text(currentSchool.name, 105, 60, { align: 'center' });
      doc.setFontSize(12);
      doc.text(`School Code: ${currentSchool.code}`, 105, 68, { align: 'center' });
      
      // Add student info
      doc.setFontSize(14);
      doc.text('STUDENT PROGRESS REPORT', 105, 110, { align: 'center' });
      doc.setFontSize(12);
      doc.text(`Student Name: ${student.name}`, 20, 130);
      doc.text(`Class: ${classObj ? classObj.name : 'N/A'}`, 20, 140);
      doc.text(`Term: ${getTermLabel(term)}`, 20, 150);
      doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 160);
      
      // Add table header
      let yPos = 180;
      doc.setFillColor(67, 97, 238);
      doc.rect(20, yPos, 170, 10, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(10);
      doc.text('SUBJECT', 25, yPos + 7);
      doc.text('SCORE', 120, yPos + 7);
      doc.text('GRADE', 150, yPos + 7);
      
      // Add subject rows
      yPos += 10;
      let totalMarks = 0;
      let subjectCount = 0;
      
      currentSubjects.forEach(subject => {
        const score = mark[subject.id] || 0;
        totalMarks += score;
        subjectCount++;
        
        doc.setFillColor(240, 240, 240);
        doc.rect(20, yPos, 170, 10, 'F');
        doc.setTextColor(0, 0, 0);
        doc.text(subject.name, 25, yPos + 7);
        doc.text(score > 0 ? score.toString() : '-', 120, yPos + 7);
        
        // Calculate grade based on school level
        const grade = score > 0 ? calculateGrade(score, currentSchool.level) : '-';
        doc.text(grade, 150, yPos + 7);
        
        yPos += 10;
      });
      
      // Add total and average
      const average = subjectCount > 0 ? Math.round(totalMarks / subjectCount) : 0;
      yPos += 5;
      doc.setFillColor(220, 220, 220);
      doc.rect(20, yPos, 170, 10, 'F');
      doc.setTextColor(0, 0, 0);
      doc.text('TOTAL MARKS', 25, yPos + 7);
      doc.text(totalMarks.toString(), 120, yPos + 7);
      
      yPos += 10;
      doc.rect(20, yPos, 170, 10, 'F');
      doc.text('AVERAGE', 25, yPos + 7);
      doc.text(average.toString(), 120, yPos + 7);
      
      // Add teacher remarks section
      yPos += 20;
      doc.setFontSize(12);
      doc.text('Teacher\'s Remarks:', 20, yPos);
      yPos += 10;
      doc.setDrawColor(0, 0, 0);
      doc.line(20, yPos, 190, yPos);
      yPos += 15;
      doc.line(20, yPos, 190, yPos);
      yPos += 15;
      doc.line(20, yPos, 190, yPos);
      
      yPos += 20;
      doc.text('Head Teacher\'s Remarks:', 20, yPos);
      yPos += 10;
      doc.line(20, yPos, 190, yPos);
      yPos += 15;
      doc.line(20, yPos, 190, yPos);
      yPos += 15;
      doc.line(20, yPos, 190, yPos);
    }
    
    // Save the PDF
    doc.save(`Skore_Point_Reports_${currentSchool.name}_${new Date().toISOString().split('T')[0]}.pdf`);
  }

  // Calculate grade based on score and school level
  function calculateGrade(score, level) {
    const gradingScale = GRADING_SCALES[level];
    
    if (level === 'primary') {
      if (score >= 90) return gradingScale[0]; // D1
      if (score >= 80) return gradingScale[1]; // D2
      if (score >= 70) return gradingScale[2]; // C3
      if (score >= 60) return gradingScale[3]; // C4
      if (score >= 50) return gradingScale[4]; // C5
      if (score >= 40) return gradingScale[5]; // C6
      if (score >= 30) return gradingScale[6]; // P7
      if (score >= 20) return gradingScale[7]; // P8
      return gradingScale[8]; // F9
    } else {
      // Secondary school grading
      if (score >= 80) return gradingScale[0]; // A
      if (score >= 70) return gradingScale[1]; // B
      if (score >= 60) return gradingScale[2]; // C
      if (score >= 50) return gradingScale[3]; // D
      return gradingScale[4]; // E
    }
  }

  // Get term label
  function getTermLabel(term) {
    switch(term) {
      case 'beginning': return 'Beginning of Term';
      case 'mid': return 'Mid Term';
      case 'end': return 'End of Term';
      default: return 'Unknown Term';
    }
  }

  // Export to Excel
  function exportToExcel() {
    // Create workbook
    const wb = XLSX.utils.book_new();
    
    // Create worksheet data
    const wsData = [
      ['Skore Point - Student Performance Report'],
      [`School: ${currentSchool.name}`],
      [`Generated on: ${new Date().toLocaleDateString()}`],
      [],
      ['Student Name', 'Class', 'Math', 'English', 'Science', 'Social Studies', 'Total', 'Average']
    ];
    
    // Add data rows
    Array.from(document.querySelectorAll('#reportTableBody tr')).forEach(tr => {
      const row = Array.from(tr.querySelectorAll('td')).map(td => td.textContent);
      wsData.push(row);
    });
    
    // Create worksheet
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    
    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Student Report');
    
    // Save the file
    XLSX.writeFile(wb, `Skore_Point_Report_${currentSchool.name}_${new Date().toISOString().split('T')[0]}.xlsx`);
  }

  // Handle login
  async function handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const loading = document.getElementById('loginLoading');
    const errorBox = document.getElementById('loginError');

    loading.style.display = 'block';
    errorBox.style.display = 'none';

    try {
      const userCredential = await window.firebase.signInWithEmailAndPassword(
        window.firebase.auth, email, password
      );
      
      // User is signed in
      currentUser = userCredential.user;
      await loadUserData(currentUser.uid);
      showSection(dashboardSection);
    } catch (error) {
      loading.style.display = 'none';
      errorBox.querySelector('span').textContent = error.message;
      errorBox.style.display = 'flex';
    }
  }

  // Handle registration
  async function handleRegister(e) {
    e.preventDefault();
    const name = document.getElementById('regName').value;
    const email = document.getElementById('regEmail').value;
    const subject = document.getElementById('regSubject').value;
    const password = document.getElementById('regPassword').value;
    const confirm = document.getElementById('confirmPassword').value;
    const error = document.getElementById('registerError');
    const success = document.getElementById('registerSuccess');
    const loading = document.getElementById('registerLoading');

    error.style.display = 'none';
    success.style.display = 'none';

    if (password !== confirm) {
      error.querySelector('span').textContent = 'Passwords do not match.';
      error.style.display = 'flex';
      return;
    }

    if (password.length < 6) {
      error.querySelector('span').textContent = 'Password must be at least 6 characters.';
      error.style.display = 'flex';
      return;
    }

    loading.style.display = 'block';
    
    try {
      const userCredential = await window.firebase.createUserWithEmailAndPassword(
        window.firebase.auth, email, password
      );
      
      // Update user profile with name
      await window.firebase.updateProfile(window.firebase.auth.currentUser, {
        displayName: name
      });
      
      // Create user document in Firestore
      await window.firebase.setDoc(
        window.firebase.doc(window.firebase.db, 'users', userCredential.user.uid),
        {
          name: name,
          email: email,
          subject: subject,
          profilePicture: userProfileUrl,
          role: 'admin', // Set as admin by default
          createdAt: new Date()
        }
      );
      
      loading.style.display = 'none';
      success.style.display = 'flex';
      
      // Set current user
      currentUser = userCredential.user;
      
      setTimeout(() => {
        showSection(dashboardSection);
      }, 2000);
    } catch (error) {
      loading.style.display = 'none';
      error.querySelector('span').textContent = error.message;
      error.style.display = 'flex';
    }
  }

  // Handle joining a school
  async function handleJoinSchool(e) {
    e.preventDefault();
    const schoolName = document.getElementById('joinSchoolName').value;
    const schoolCode = document.getElementById('joinSchoolCode').value;
    const errorBox = document.getElementById('joinSchoolError');

    try {
      // Find school by name and code
      const schoolsQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'schools'),
        window.firebase.where('name', '==', schoolName),
        window.firebase.where('code', '==', schoolCode)
      );
      
      const querySnapshot = await window.firebase.getDocs(schoolsQuery);
      
      if (querySnapshot.empty) {
        errorBox.querySelector('span').textContent = 'School not found. Please check the name and code.';
        errorBox.style.display = 'flex';
        return;
      }
      
      // School found, add user to school
      const schoolDoc = querySnapshot.docs[0];
      currentSchool = {
        id: schoolDoc.id,
        ...schoolDoc.data()
      };
      
      // Update user document with school ID
      await window.firebase.updateDoc(
        window.firebase.doc(window.firebase.db, 'users', currentUser.uid),
        {
          schoolId: schoolDoc.id,
          role: 'teacher' // Set as teacher when joining a school
        }
      );
      
      // Update UI
      currentSchoolName.textContent = currentSchool.name;
      currentSchoolCode.textContent = currentSchool.code;
      document.getElementById('schoolInfo').style.display = 'block';
      manageSchoolCard.style.display = 'block';
      
      // Update school card info
      schoolCardName.textContent = currentSchool.name;
      schoolCardCode.textContent = currentSchool.code;
      
      // Load school logo if available
      if (currentSchool.logoUrl) {
        schoolLogoUrl = currentSchool.logoUrl;
        schoolCardLogo.src = currentSchool.logoUrl;
        schoolCardLogo.style.display = 'block';
      }
      
      hideFullScreenForm();
      showSection(dashboardSection);
    } catch (error) {
      console.error('Error joining school:', error);
      errorBox.querySelector('span').textContent = 'Error joining school. Please try again.';
      errorBox.style.display = 'flex';
    }
  }

  // Handle registering a new school
  async function handleRegisterSchool(e) {
    e.preventDefault();
    const schoolName = document.getElementById('registerSchoolName').value;
    const schoolLocation = document.getElementById('registerSchoolLocation').value;
    const schoolPhone = document.getElementById('registerSchoolPhone').value;
    const schoolLevel = document.getElementById('registerSchoolLevel').value;
    const logoUrl = document.getElementById('logoUrl').value;
    const errorBox = document.getElementById('registerSchoolError');
    const successBox = document.getElementById('registerSchoolSuccess');

    if (!schoolLevel) {
      errorBox.querySelector('span').textContent = 'Please select a school level.';
      errorBox.style.display = 'flex';
      return;
    }

    try {
      // Generate a random 6-character code
      const schoolCode = generateSchoolCode();
      
      // Create school document
      const schoolRef = await window.firebase.addDoc(
        window.firebase.collection(window.firebase.db, 'schools'),
        {
          name: schoolName,
          location: schoolLocation,
          phone: schoolPhone,
          level: schoolLevel,
          code: schoolCode,
          logoUrl: logoUrl,
          createdBy: currentUser.uid,
          createdAt: new Date()
        }
      );
      
      // Update user document with school ID
      await window.firebase.updateDoc(
        window.firebase.doc(window.firebase.db, 'users', currentUser.uid),
        {
          schoolId: schoolRef.id,
          role: 'admin' // Set as admin when creating a school
        }
      );
      
      // Add default subjects based on school level
      const defaultSubjects = DEFAULT_SUBJECTS[schoolLevel];
      for (const subjectName of defaultSubjects) {
        await window.firebase.addDoc(
          window.firebase.collection(window.firebase.db, 'subjects'),
          {
            name: subjectName,
            schoolId: schoolRef.id,
            createdAt: new Date()
          }
        );
      }
      
      // Set current school
      currentSchool = {
        id: schoolRef.id,
        name: schoolName,
        location: schoolLocation,
        phone: schoolPhone,
        level: schoolLevel,
        code: schoolCode,
        logoUrl: logoUrl
      };
      
      // Update UI
      currentSchoolName.textContent = currentSchool.name;
      currentSchoolCode.textContent = currentSchool.code;
      document.getElementById('schoolInfo').style.display = 'block';
      manageSchoolCard.style.display = 'block';
      
      // Update school card info
      schoolCardName.textContent = currentSchool.name;
      schoolCardCode.textContent = currentSchool.code;
      
      // Load school logo if available
      if (currentSchool.logoUrl) {
        schoolLogoUrl = currentSchool.logoUrl;
        schoolCardLogo.src = currentSchool.logoUrl;
        schoolCardLogo.style.display = 'block';
      }
      
      successBox.style.display = 'flex';
      
      setTimeout(() => {
        hideFullScreenForm();
        showSection(dashboardSection);
      }, 2000);
    } catch (error) {
      console.error('Error registering school:', error);
      errorBox.querySelector('span').textContent = 'Error registering school. Please try again.';
      errorBox.style.display = 'flex';
    }
  }

  // Generate a random school code
  function generateSchoolCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < 6; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }

  // Handle adding a class
  async function handleAddClass(e) {
    e.preventDefault();
    const className = document.getElementById('className').value;
    
    try {
      // Add class to school
      await window.firebase.addDoc(
        window.firebase.collection(window.firebase.db, 'classes'),
        {
          name: className,
          schoolId: currentSchool.id,
          createdAt: new Date()
        }
      );
      
      // Clear form and reload classes
      document.getElementById('className').value = '';
      loadClasses();
      populateClassSelectors();
    } catch (error) {
      console.error('Error adding class:', error);
      alert('Error adding class. Please try again.');
    }
  }

  // Handle adding a subject
  async function handleAddSubject(e) {
    e.preventDefault();
    const subjectName = document.getElementById('subjectName').value;
    
    try {
      // Add subject to school
      await window.firebase.addDoc(
        window.firebase.collection(window.firebase.db, 'subjects'),
        {
          name: subjectName,
          schoolId: currentSchool.id,
          createdAt: new Date()
        }
      );
      
      // Clear form and reload subjects
      document.getElementById('subjectName').value = '';
      loadSubjects();
    } catch (error) {
      console.error('Error adding subject:', error);
      alert('Error adding subject. Please try again.');
    }
  }

  // Load classes for the current school
  async function loadClasses() {
    try {
      const classesQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'classes'),
        window.firebase.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await window.firebase.getDocs(classesQuery);
      currentClasses = [];
      const classList = document.getElementById('classList');
      classList.innerHTML = '';
      
      querySnapshot.forEach(doc => {
        const classData = {
          id: doc.id,
          ...doc.data()
        };
        currentClasses.push(classData);
        
        // Add to UI
        const classCard = document.createElement('div');
        classCard.className = 'class-card';
        classCard.innerHTML = `
          <h4>${classData.name}</h4>
          <p>Created: ${classData.createdAt.toDate().toLocaleDateString()}</p>
          <div class="card-actions">
            <button class="btn btn-success" onclick="viewClass('${doc.id}')"><i class="fas fa-eye"></i> View</button>
            <button class="btn btn-danger" onclick="deleteClass('${doc.id}')"><i class="fas fa-trash"></i> Delete</button>
          </div>
        `;
        classList.appendChild(classCard);
      });
    } catch (error) {
      console.error('Error loading classes:', error);
    }
  }

  // Load subjects for the current school
  async function loadSubjects() {
    try {
      const subjectsQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'subjects'),
        window.firebase.where('schoolId', '==', currentSchool.id)
      );
      
      const querySnapshot = await window.firebase.getDocs(subjectsQuery);
      currentSubjects = [];
      const subjectsList = document.getElementById('subjectsList');
      subjectsList.innerHTML = '';
      
      querySnapshot.forEach(doc => {
        const subjectData = {
          id: doc.id,
          ...doc.data()
        };
        currentSubjects.push(subjectData);
        
        // Add to UI
        const subjectCard = document.createElement('div');
        subjectCard.className = 'subject-card';
        subjectCard.innerHTML = `
          <h4>${subjectData.name}</h4>
          <p>Created: ${subjectData.createdAt.toDate().toLocaleDateString()}</p>
          <div class="card-actions">
            <button class="btn btn-danger" onclick="deleteSubject('${doc.id}')"><i class="fas fa-trash"></i> Delete</button>
          </div>
        `;
        subjectsList.appendChild(subjectCard);
      });
    } catch (error) {
      console.error('Error loading subjects:', error);
    }
  }

  // Load students for the selected class
  async function loadStudents() {
    const classId = document.getElementById('studentClassSelect').value;
    if (!classId) return;
    
    try {
      const studentsQuery = window.firebase.query(
        window.firebase.collection(window.firebase.db, 'students'),
        window.firebase.where('classId', '==', classId)
      );
      
      const querySnapshot = await window.firebase.getDocs(studentsQuery);
      currentStudents = [];
      const studentList = document.getElementById('studentList');
      studentList.innerHTML = '';
      
      querySnapshot.forEach(doc => {
        const studentData = {
          id: doc.id,
          ...doc.data()
        };
        currentStudents.push(studentData);
        
        // Add to UI
        const studentCard = document.createElement('div');
        studentCard.className = 'student-card';
        studentCard.innerHTML = `
          <h4>${studentData.name}</h4>
          <p>Class: ${getClassName(studentData.classId)}</p>
          <div class="card-actions">
            <button class="btn btn-danger" onclick="deleteStudent('${doc.id}')"><i class="fas fa-trash"></i> Delete</button>
          </div>
        `;
        studentList.appendChild(studentCard);
      });
    } catch (error) {
      console.error('Error loading students:', error);
    }
  }

  // Get class name by ID
  function getClassName(classId) {
    const classObj = currentClasses.find(c => c.id === classId);
    return classObj ? classObj.name : 'Unknown Class';
  }

  // Populate class selectors in various forms
  function populateClassSelectors() {
    const studentClassSelect = document.getElementById('studentClassSelect');
    const marksClassSelect = document.getElementById('marksClassSelect');
    const reportClassSelect = document.getElementById('reportClassSelect');
    
    // Clear existing options except the first one
    while (studentClassSelect.options.length > 1) {
      studentClassSelect.remove(1);
    }
    while (marksClassSelect.options.length > 1) {
      marksClassSelect.remove(1);
    }
    while (reportClassSelect.options.length > 1) {
      reportClassSelect.remove(1);
    }
    
    // Add classes to selectors
    currentClasses.forEach(classObj => {
      const option1 = document.createElement('option');
      option1.value = classObj.id;
      option1.textContent = classObj.name;
      studentClassSelect.appendChild(option1);
      
      const option2 = document.createElement('option');
      option2.value = classObj.id;
      option2.textContent = classObj.name;
      marksClassSelect.appendChild(option2);
      
      const option3 = document.createElement('option');
      option3.value = classObj.id;
      option3.textContent = classObj.name;
      reportClassSelect.appendChild(option3);
    });
    
    // Add event listeners
    studentClassSelect.addEventListener('change', loadStudents);
    marksClassSelect.addEventListener('change', setupMarksEntry);
  }

  // Handle student upload from Excel file
  async function handleStudentUpload() {
    const fileInput = document.getElementById('studentFile');
    const classId = document.getElementById('studentClassSelect').value;
    const errorBox = document.getElementById('studentUploadError');
    const successBox = document.getElementById('studentUploadSuccess');
    
    if (!classId) {
      errorBox.querySelector('span').textContent = 'Please select a class first.';
      errorBox.style.display = 'flex';
      return;
    }
    
    if (!fileInput.files.length) return;
    
    const file = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = async function(e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        
        // Assume first sheet
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);
        
        // Process each row (student)
        for (const row of jsonData) {
          // Assuming the first column contains student names
          const studentName = row[Object.keys(row)[0]];
          
          if (studentName) {
            await window.firebase.addDoc(
              window.firebase.collection(window.firebase.db, 'students'),
              {
                name: studentName,
                classId: classId,
                schoolId: currentSchool.id,
                createdAt: new Date()
              }
            );
          }
        }
        
        successBox.style.display = 'flex';
        fileInput.value = '';
        loadStudents(); // Refresh student list
      } catch (error) {
        console.error('Error processing Excel file:', error);
        errorBox.querySelector('span').textContent = 'Error processing Excel file. Please check the format.';
        errorBox.style.display = 'flex';
      }
    };
    
    reader.readAsArrayBuffer(file);
  }

  // Logout user
  async function logout() {
    try {
      await window.firebase.signOut(window.firebase.auth);
      currentUser = null;
      currentSchool = null;
      portalOpened = false;
      showSection(loginSection);
    } catch (error) {
      console.error('Error signing out:', error);
    }
  }

  // Show alert message
  function showAlert(elementId, message) {
    const alert = document.getElementById(elementId);
    alert.querySelector('span').textContent = message;
    alert.style.display = 'flex';
  }

  // Placeholder functions for class, student and subject actions
  window.viewClass = (classId) => {
    alert(`View class ${classId}`);
  };
  
  window.deleteClass = async (classId) => {
    if (confirm('Are you sure you want to delete this class? This will also delete all students in this class.')) {
      try {
        await window.firebase.deleteDoc(
          window.firebase.doc(window.firebase.db, 'classes', classId)
        );
        loadClasses();
        populateClassSelectors();
      } catch (error) {
        console.error('Error deleting class:', error);
        alert('Error deleting class. Please try again.');
      }
    }
  };
  
  window.deleteStudent = async (studentId) => {
    if (confirm('Are you sure you want to delete this student?')) {
      try {
        await window.firebase.deleteDoc(
          window.firebase.doc(window.firebase.db, 'students', studentId)
        );
        loadStudents();
      } catch (error) {
        console.error('Error deleting student:', error);
        alert('Error deleting student. Please try again.');
      }
    }
  };
  
  window.deleteSubject = async (subjectId) => {
    if (confirm('Are you sure you want to delete this subject?')) {
      try {
        await window.firebase.deleteDoc(
          window.firebase.doc(window.firebase.db, 'subjects', subjectId)
        );
        loadSubjects();
      } catch (error) {
        console.error('Error deleting subject:', error);
        alert('Error deleting subject. Please try again.');
      }
    }
  };

  // Add logout functionality
  document.addEventListener('DOMContentLoaded', function() {
    // Create logout button if it doesn't exist
    if (!document.getElementById('logoutBtn')) {
      const logoutBtn = document.createElement('button');
      logoutBtn.id = 'logoutBtn';
      logoutBtn.className = 'logout-btn';
      logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Logout';
      logoutBtn.onclick = logout;
      
      // Add to dashboard header
      const dashboardTopSection = document.querySelector('.dashboard-top-section');
      if (dashboardTopSection) {
        dashboardTopSection.appendChild(logoutBtn);
      }
      
      // Add to school management header
      const managementHeader = document.querySelector('.management-header');
      if (managementHeader) {
        managementHeader.appendChild(logoutBtn.cloneNode(true));
      }
    }
  });
</script>
</body> 
</html>
